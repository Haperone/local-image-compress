## Local Image Compress — локальное сжатие изображений (offline)

Лёгкий и быстрый плагин для локального сжатия PNG/JPEG изображений в вашем хранилище без использования облачных API. Плагин использует системные бинарники `pngquant` и `mozjpeg`, работает офлайн, поддерживает пакетное сжатие, автоматизацию в фоне и аккуратное перемещение сжатых файлов с созданием резервных копий.

[English version](README.md)

### Установка
1. Скопируйте папку плагина в `Vault/.obsidian/plugins/local-image-compress`.
2. Убедитесь, что в папке плагина есть `node_modules` с бинарниками:
   - `node_modules/pngquant-bin/vendor/pngquant(.exe)`
   - `node_modules/mozjpeg/vendor/` (исполняемый файл от mozjpeg)
3. Откройте `Settings → Community plugins` и включите `Local Image Compress`.

Плагин поддерживает три способа обнаружения бинарников (в порядке приоритета):
1) Явные пути в настройках: «Путь к pngquant», «Путь к mozjpeg»
2) Автопоиск в системе (PATH): `pngquant`, `mozjpeg`
3) Вшитые бинарники в папке плагина: `node_modules/pngquant-bin/vendor/…`, `node_modules/mozjpeg/vendor/…`

Если бинарники не обнаружены ни одним способом, вверху страницы настроек появится красное предупреждение с просьбой указать пути/установить бинарники.

### Установка бинарников на Windows

Вариант A — npm локально (рекомендуется, не требует админ‑прав)
```powershell
cd "path/to/obsidian-local-image-compress"
npm init -y
npm i pngquant-bin mozjpeg --omit=dev
# Плагин автоматически найдёт бинарники в node_modules
```

Вариант B — Scoop (user‑scope, без админа)
```powershell
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned -Force
irm get.scoop.sh | iex
scoop install git
scoop bucket add extras
scoop install pngquant
scoop install mozjpeg
# Проверка
pngquant --version
mozjpeg -version
```

Если Scoop пишет про admin — установите без админа (команды выше). Если требует git — `scoop install git` или `winget install Git.Git`.

Вариант C — вручную
- Скачайте исполняемые файлы `pngquant` и `mozjpeg`, укажите пути в настройках плагина: «Путь к pngquant», «Путь к mozjpeg».
- Либо положите в `node_modules/pngquant-bin/vendor/` и `node_modules/mozjpeg/vendor/`.

### Установка бинарников на macOS

Вариант A — Homebrew (рекомендуется)
```bash
brew update
brew install pngquant mozjpeg
# Проверка
pngquant --version
mozjpeg -version
```

Вариант B — npm локально (в папке плагина/репо)
```bash
cd path/to/obsidian-local-image-compress
npm init -y
npm i pngquant-bin mozjpeg --omit=dev
# Плагин автоматически найдёт бинарники в node_modules
```

Вариант C — вручную
- Скачайте исполняемые файлы `pngquant` и `mozjpeg` для macOS и укажите их пути в настройках плагина.
- Либо поместите их в `node_modules/pngquant-bin/vendor/` и `node_modules/mozjpeg/vendor/`.

### Возможности
- **Локальное сжатие**: PNG через `pngquant`, JPEG через `mozjpeg`.
- **Команды**:
  - Сжать все изображения в текущей заметке
  - Сжать все изображения в папке
  - Сжать все изображения во всём vault
  - Переместить сжатые файлы (по оригинальным путям)
- **Автоматизация**:
  - Автосжатие новых файлов при добавлении
  - Фоновое сжатие при неактивности пользователя и превышении порога несжатых изображений
- **UI и удобства**:
  - Контекстное меню для файлов/папок
  - Индикатор экономии места и tooltip с деталями
  - Статус-бар с индикатором процесса
- **Безопасность и надёжность**:
  - Кэш обработанных файлов с бэкапами кэша
  - Резервные копии перед перемещением сжатых файлов

### Команды
- **Сжать все изображения в заметке**: Обрабатывает изображения, упомянутые/используемые в активной заметке.
- **Сжать все изображения в папке**: Выбор папки и сжатие всех поддерживаемых изображений внутри (кроме папки вывода).
- **Сжать все изображения в vault**: Полный проход по хранилищу, исключая папку вывода.
- **Переместить сжатые файлы (на места оригиналов)**: Переносит результаты сжатия туда, где лежали оригиналы. Перед перемещением создаётся резервная копия оригиналов и сжатых версий.

### Поддерживаемые форматы
- PNG (`pngquant`)
- JPEG/JPG (`mozjpeg`)

### Настройки

| Параметр | Описание | Тип/диапазон | По умолчанию |
|---|---|---|---|
| Качество PNG (мин-макс) | Диапазон качества для `pngquant` | 0–100 (например `65-80`) | `65-80` |
| Качество JPEG | Качество для `mozjpeg` | 1–95 | `85` |
| Разрешённые корни | Относительные пути, где разрешено сжатие. Пусто = везде | список строк (строки через перевод строки) | пусто |
| Выходная папка | Папка для сохранения сжатых файлов | строка | `Compressed` |
| Автосжатие новых файлов | Сжимать новые изображения при добавлении | boolean | `false` |
| Авто фоновое сжатие | Сжимать в фоне при неактивности | boolean | `true` |
| Порог фонового сжатия | Кол-во несжатых изображений для автозапуска | 10–1000 | `50` |
| Путь к pngquant | Полный путь к бинарнику pngquant или пусто для автопоиска | строка | пусто |
| Путь к mozjpeg | Полный путь к бинарнику mozjpeg или пусто для автопоиска | строка | пусто |
| Автоочистка призраков при старте | Удалять записи кэша на удалённые файлы при запуске | boolean | `false` |
| Хранить бэкапы, дней | Удалять бэкапы старше N дней (0 = не удалять) | 0–365 | `30` |

Дополнительно: в настройках есть индикатор экономии места и блоки с управлением кэшем, призрачными записями и бэкапами.

### Как это работает
1. При сжатии создаются выходные файлы в папке `Compressed` с повторением структуры путей.
2. В кэше фиксируется факт обработки файлов и исходный размер, чтобы не сжимать повторно и корректно считать экономию.
3. Команда «Переместить сжатые файлы» переносит файлы из `Compressed` на места оригиналов (если оригинал найден в разрешённых корнях). Перед перемещением создаётся резервная копия оригиналов и сжатых версий.

Минимальные размеры для сжатия: очень маленькие файлы (обычно `<5KB` для PNG и `<10KB` для JPEG) пропускаются.

### Кэш и бэкапы
- **Кэш**: хранится в `Vault/.obsidian/plugins/local-image-compress/tinyLocal-cache.json`. Доступны операции:
  - Очистить кэш
  - Обновить кэш
  - Восстановить кэш из бэкапа (список бэкапов доступен в настройках)
- **Бэкапы кэша**: создаются автоматически при важных изменениях в `cache-backups/`.
- **Бэкапы перед переносом**: сохраняются в `original-files-backups/` внутри директории плагина. Включают оригиналы (по относительным путям vault) и сжатые файлы.
  - В настройках есть кнопка «Открыть папку бэкапов изображений».
  - Очистка старых бэкапов выполняется автоматически при запуске плагина по правилу «Хранить бэкапы, дней».

### Автоматизация (динамические настройки)
- «Автоматическое фоновое сжатие» — при включении появляется ползунок «Порог для фонового сжатия».
- «Хранить бэкапы, дней — включить» — при включении появляется ползунок количества дней.
- «Автоперемещение сжатых файлов — включить» — при включении появляется ползунок «Порог автоперемещения (шт.)». При запуске плагина, если в `Compressed` ≥ порога, запускается перемещение.

### Статус-бар и индикатор экономии
- В статус-баре отображается состояние (процесс сжатия и др.).
- На странице настроек показывается блок «экономии места» с подсказкой: исходный размер, текущий, экономия (%) и статистика обработанных файлов.

### Ограничения и совместимость
- Плагин работает только на **Desktop** (`isDesktopOnly: true`).
- Требуется версия приложения `1.0.0+`.
- Для корректной работы необходимы бинарники `pngquant` и `mozjpeg` для вашей платформы (Windows/macOS/Linux).
- Во время операций временно отключается совместимый плагин `obsidian-paste-image-rename` (если включён), чтобы избежать конфликтов с именованием/перемещением.

### Советы по использованию
- Держите разумный диапазон качества: PNG `65-80`, JPEG `75-90` — баланс между размером и качеством.
- Настройте «Разрешённые корни», если хотите сжимать только в определённых папках (например, `files/`, `images/`).
- Используйте фоновое сжатие, если у вас много несжатых изображений: оно запустится при неактивности и превышении порога.

### Частые вопросы (FAQ)
**Плагин пишет, что бинарники не найдены.**
— Проверьте наличие файлов в `node_modules/pngquant-bin/vendor/` и `node_modules/mozjpeg/vendor/`. Убедитесь, что файлы имеют права на запуск (macOS/Linux) или корректные `.exe` на Windows.

**Где оказываются сжатые файлы?**
— В папке `Compressed` (можно изменить в настройках). Для замены оригиналов используйте команду «Переместить сжатые файлы в Files» — она перенесёт соответствующие сжатые файлы на места оригиналов и создаст бэкап.

**Как посчитать экономию?**
— На странице настроек есть индикатор экономии и подсказка. Плагин учитывает оригинальные размеры (хранятся в кэше) и текущие размеры.

**Что такое «призрачные записи»?**
— Это записи в кэше, которые указывают на удалённые или отсутствующие файлы. Их можно очистить кнопкой в настройках.

### Диагностика и троблшутинг
- Убедитесь, что файлы достаточно большие: слишком маленькие изображения плагин пропускает.
- Проверьте настройки «Разрешённые корни»: файлы вне этих путей не будут обрабатываться.
- Если перенос не происходит — убедитесь, что у сжатого файла есть соответствующий оригинал в разрешённом корне.
- Смотрите уведомления приложения и консоль разработчика (Ctrl+Shift+I) для логов `Local Image Compress`.

### Метаданные
- ID: `local-image-compress`
- Имя: `Local Image Compress`
- Версия: `1.0.0`
- Минимальная версия приложения: `1.0.0`
- Desktop-only: да

### Лицензия
- Код плагина: MIT (см. файл `LICENSE`).
- Сторонние компоненты: `pngquant` — GPL-3.0; `mozjpeg` — BSD-3-Clause/IJG. Подробности и ссылки см. `THIRD_PARTY_NOTICES.md`.
